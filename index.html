<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Journal</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app">
        <!-- Sign In Screen -->
        <div id="signInScreen" class="flex items-center justify-center min-h-screen bg-gray-50">
            <button id="signInButton" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                Sign in with Google
            </button>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden flex flex-col h-screen">
            <!-- Header -->
            <header class="bg-blue-600 text-white px-5 py-3 flex justify-between items-center">
                <div class="text-sm" id="userInfo"></div>
                <button id="signOutButton" class="px-3 py-1.5 bg-red-500 text-white rounded hover:bg-red-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Sign Out
                </button>
            </header>

            <!-- Main Content -->
            <div class="flex flex-1 overflow-hidden">
                <!-- Sidebar -->
                <aside class="w-72 bg-gray-50 p-5 overflow-y-auto shadow-md">
                    <h2 id="currentMonth" class="text-xl font-semibold text-center mb-4"></h2>
                    <ul id="entriesList" class="space-y-1"></ul>
                </aside>

                <!-- Editor -->
                <div class="flex-1 p-5 flex flex-col gap-4">
                    <textarea
                        id="journalEditor"
                        placeholder="Write your journal entry here..."
                        class="flex-1 p-4 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                    <button
                        id="saveButton"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2 self-end"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB00L-6PsCK5LMAVbUPXgNNF0BywlZKqwk",
            authDomain: "weekly-journal-9df9c.firebaseapp.com",
            projectId: "weekly-journal-9df9c",
            storageBucket: "weekly-journal-9df9c.appspot.com",
            messagingSenderId: "267644429656",
            appId: "1:267644429656:web:8a5b8a73960f9adf5af12d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let currentEntry = null;

        // DOM Elements
        const signInScreen = document.getElementById('signInScreen');
        const mainApp = document.getElementById('mainApp');
        const userInfo = document.getElementById('userInfo');
        const currentMonth = document.getElementById('currentMonth');
        const entriesList = document.getElementById('entriesList');
        const journalEditor = document.getElementById('journalEditor');

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                signInScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userInfo.textContent = `Logged in as: ${user.displayName} (${user.email})`;
                loadEntries();
            } else {
                signInScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                entriesList.innerHTML = '';
                journalEditor.value = '';
            }
        });

        // Get week number
        function getWeekNumber(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            return Math.ceil((((date.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
        }

        // Load entries
        async function loadEntries() {
            if (!currentUser) return;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.toLocaleString('default', { month: 'long' });
            currentMonth.textContent = month;

            const entriesRef = db.collection('users').doc(currentUser.uid).collection('entries');
            const snapshot = await entriesRef
                .where('year', '==', year)
                .where('month', '==', month)
                .get();

            entriesList.innerHTML = '';
            snapshot.forEach(doc => {
                const entry = doc.data();
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100 rounded transition-colors';
                li.innerHTML = `
                    <div class="font-medium">Week ${entry.week}</div>
                    <p class="text-sm text-gray-600 truncate">${entry.notes}</p>
                `;
                li.onclick = () => selectEntry({ id: doc.id, ...entry });
                entriesList.appendChild(li);
            });
        }

        // Select entry
        function selectEntry(entry) {
            currentEntry = entry;
            journalEditor.value = entry.notes;
        }

        // Save entry
        async function saveEntry() {
            if (!currentUser) return;

            const now = new Date();
            const notes = journalEditor.value;
            const year = now.getFullYear();
            const month = now.toLocaleString('default', { month: 'long' });
            const week = getWeekNumber(now);

            const entryData = {
                notes,
                year,
                month,
                week,
                updatedAt: new Date().toISOString()
            };

            try {
                if (currentEntry) {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('entries').doc(currentEntry.id)
                        .update(entryData);
                } else {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('entries').add({
                            ...entryData,
                            createdAt: new Date().toISOString()
                        });
                }

                await loadEntries();
                currentEntry = null;
                journalEditor.value = '';
                alert('Entry saved successfully!');
            } catch (error) {
                console.error('Error saving entry:', error);
                alert('Failed to save entry');
            }
        }

        // Event Listeners
        document.getElementById('signInButton').onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        };

        document.getElementById('signOutButton').onclick = () => {
            auth.signOut();
        };

        document.getElementById('saveButton').onclick = saveEntry;
    </script>
</body>
</html>
